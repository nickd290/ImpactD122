// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Entity Types (Customers & Vendors)
enum EntityType {
  CUSTOMER
  VENDOR
}

// Job Status Workflow
enum JobStatus {
  DRAFT
  QUOTED
  APPROVED
  PO_ISSUED
  IN_PRODUCTION
  SHIPPED
  INVOICED
  PAID
  CANCELLED
}

// Product Types
enum ProductType {
  BOOK
  FLAT
  FOLDED
  OTHER
}

// Cover Types (for books)
enum CoverType {
  SELF
  PLUS
}

// Entities (Customers & Vendors)
model Entity {
  id                  String    @id @default(cuid())
  name                String
  type                EntityType
  uniqueCode          String?   @unique // 3-digit code for document numbering (e.g., "ABC", "XYZ")
  email               String
  phone               String
  address             String
  contactPerson       String
  isPartner           Boolean   @default(false) // For Bradford partner vendor
  notes               String?

  // Document counters
  lastInvoiceNumber   Int       @default(0) // For customers
  lastPONumber        Int       @default(0) // For vendors

  // Relations
  contacts            Contact[]
  jobsAsCustomer      Job[]     @relation("CustomerJobs")
  jobsAsVendor        Job[]     @relation("VendorJobs")
  capability          VendorCapability?
  vendorQuotes        VendorQuote[]     @relation("VendorQuotes")
  jobVendors          JobVendor[]       @relation("JobVendorAssignments")

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([type])
  @@index([name])
  @@index([uniqueCode])
}

// Additional Contacts for Entities
model Contact {
  id                  String    @id @default(cuid())
  entityId            String
  name                String
  email               String
  phone               String?
  isPrimary           Boolean   @default(false)

  entity              Entity    @relation(fields: [entityId], references: [id], onDelete: Cascade)

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([entityId])
}

// Jobs
model Job {
  id                  String      @id @default(cuid())
  number              String      @unique // e.g., "J-1001"
  title               String
  customerId          String
  vendorId            String
  bradfordRefNumber   String?     // PO to JD Graphic

  // Documents
  customerPONumber    String?
  originalPOUrl       String?     // File path or base64
  vendorPONumber      String?
  invoiceNumber       String?
  quoteNumber         String?

  // Document tracking
  generatedDocuments  Json        @default("[]") // Array of {type, number, generatedAt, generatedBy, downloadUrl}

  // Logistics
  artworkUrl          String?
  artworkFilename     String?

  status              JobStatus   @default(DRAFT)
  locked              Boolean     @default(false)
  isDuplicate         Boolean     @default(false) // Flag to mark suspected duplicates

  dateCreated         DateTime    @default(now())
  dueDate             DateTime?
  notes               String      @default("")

  // Relations
  customer            Entity      @relation("CustomerJobs", fields: [customerId], references: [id])
  vendor              Entity      @relation("VendorJobs", fields: [vendorId], references: [id])
  lineItems           LineItem[]
  specs               JobSpecs?
  financials          JobFinancials?
  quoteRequests       QuoteRequest[]
  jobVendors          JobVendor[]       @relation("JobVendors")

  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  @@index([customerId])
  @@index([vendorId])
  @@index([status])
  @@index([number])
}

// Job Specifications
model JobSpecs {
  id                  String      @id @default(cuid())
  jobId               String      @unique

  productType         ProductType @default(OTHER)

  // Common specs
  colors              String?     // "4/4", "4/1", "PMS"
  coating             String?
  finishing           String?

  // Sizes
  flatSize            String?
  finishedSize        String?

  // Paper
  paperType           String?     // Text/main stock

  // Book-specific
  pageCount           Int?
  bindingStyle        String?     // Saddle Stitch, Perfect
  coverType           CoverType?
  coverPaperType      String?

  job                 Job         @relation(fields: [jobId], references: [id], onDelete: Cascade)

  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
}

// Job Financials (Partner vs Standard models)
model JobFinancials {
  id                  String      @id @default(cuid())
  jobId               String      @unique

  // Partner (Bradford) model - Legacy CPM fields
  paperCostCPM        Float?      // Cost per thousand
  paperSellCPM        Float?      // Sell price per thousand
  paperUsage          String?     // e.g., "12,000 sheets 25x38"
  manufacturingCPM    Float?      // Manufacturing cost

  // Partner (Bradford) model - New total-based pricing
  jdServicesTotal     Float?      // Total JD Graphic charges Bradford
  bradfordPaperCost   Float?      // What Bradford paid for paper
  paperMarkupAmount   Float?      // Dollar markup on paper to Impact
  impactCustomerTotal Float?      // Total customer pays Impact
  calculatedSpread    Float?      // Spread = Customer - (Paper+Markup+JD)
  bradfordShareAmount Float?      // Bradford's 50% of spread
  impactCostFromBradford Float?   // Total Impact pays Bradford

  // Standard model
  consultantFee       Float?      // Flat fee for Bradford

  job                 Job         @relation(fields: [jobId], references: [id], onDelete: Cascade)

  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
}

// Line Items
model LineItem {
  id                  String      @id @default(cuid())
  jobId               String
  description         String
  quantity            Int
  unitCost            Float       // Vendor cost
  markupPercent       Float
  unitPrice           Float       // Customer price
  sortOrder           Int         @default(0)

  job                 Job         @relation(fields: [jobId], references: [id], onDelete: Cascade)

  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  @@index([jobId])
}

// Vendor Capabilities
model VendorCapability {
  id                  String      @id @default(cuid())
  vendorId            String      @unique

  // Service capabilities (boolean flags)
  printing            Boolean     @default(true)   // Base printing service
  binding             Boolean     @default(false)
  foilStamping        Boolean     @default(false)
  embossing           Boolean     @default(false)
  dieCutting          Boolean     @default(false)
  uvCoating           Boolean     @default(false)
  lamination          Boolean     @default(false)
  scoring             Boolean     @default(false)
  folding             Boolean     @default(false)

  // Detailed capabilities (arrays for flexibility)
  bindingTypes        String[]    // ["Perfect Bound", "Saddle Stitch", "Coil", "Case Binding"]
  foilColors          String[]    // ["Gold", "Silver", "Copper", "Red", "Blue"]
  coatingTypes        String[]    // ["UV", "Aqueous", "Soft Touch", "Gloss"]

  // Equipment & capacity
  maxSheetSize        String?     // "25x38", "28x40"
  minQuantity         Int?        // Minimum order quantity
  maxQuantity         Int?        // Maximum capacity per job

  // Business details
  avgLeadTimeDays     Int?        // Typical turnaround time
  notes               String?     // Free-form notes about capabilities

  // Relations
  vendor              Entity      @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  @@index([vendorId])
}

// Quote Request Status
enum QuoteRequestStatus {
  DRAFT               // Being prepared
  SENT                // Sent to vendors
  RESPONSES_RECEIVED  // At least one quote received
  AWARDED             // Vendor(s) selected
  CANCELLED           // Cancelled
}

// Quote Requests
model QuoteRequest {
  id                  String                @id @default(cuid())
  jobId               String
  requestNumber       String                @unique  // QR-1001, QR-1002, etc.

  // Request details
  specs               Json                  // Snapshot of JobSpecs at time of request
  requiredServices    String[]              // ["printing", "binding", "foilStamping"]
  dueDate             DateTime?
  notes               String?

  // Status tracking
  status              QuoteRequestStatus    @default(DRAFT)
  sentAt              DateTime?

  // Relations
  job                 Job                   @relation(fields: [jobId], references: [id], onDelete: Cascade)
  vendorQuotes        VendorQuote[]

  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt

  @@index([jobId])
  @@index([status])
  @@index([requestNumber])
}

// Vendor Quote Status
enum VendorQuoteStatus {
  PENDING       // Awaiting response from vendor
  RECEIVED      // Quote received
  ACCEPTED      // Vendor selected for this job
  DECLINED      // Vendor declined to quote
  REJECTED      // Quote rejected by Impact
}

// Vendor Quotes (responses to quote requests)
model VendorQuote {
  id                  String              @id @default(cuid())
  quoteRequestId      String
  vendorId            String

  // Quote details
  quoteNumber         String?             // Vendor's quote/estimate number
  totalCost           Float?
  leadTimeDays        Int?
  notes               String?

  // Line items breakdown (JSON for flexibility)
  lineItems           Json?               // Array of {service, description, quantity, unitCost, total}

  // Status & tracking
  status              VendorQuoteStatus   @default(PENDING)
  sentEmailAt         DateTime?           // When RFQ email was sent
  receivedAt          DateTime?           // When quote was received
  acceptedAt          DateTime?           // When quote was accepted
  declinedAt          DateTime?           // When vendor declined
  declineReason       String?

  // Relations
  quoteRequest        QuoteRequest        @relation(fields: [quoteRequestId], references: [id], onDelete: Cascade)
  vendor              Entity              @relation("VendorQuotes", fields: [vendorId], references: [id], onDelete: Cascade)

  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  @@index([quoteRequestId])
  @@index([vendorId])
  @@index([status])
}

// Job-Vendor Junction (for multi-vendor jobs)
model JobVendor {
  id                  String      @id @default(cuid())
  jobId               String
  vendorId            String

  // Assignment details
  services            String[]    // Which services this vendor provides ["printing", "binding"]
  poNumber            String?     // PO number for this vendor
  cost                Float?      // Cost from this vendor
  status              String?     // Status of work with this vendor
  notes               String?

  // Relations
  job                 Job         @relation("JobVendors", fields: [jobId], references: [id], onDelete: Cascade)
  vendor              Entity      @relation("JobVendorAssignments", fields: [vendorId], references: [id], onDelete: Cascade)

  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  @@unique([jobId, vendorId])
  @@index([jobId])
  @@index([vendorId])
}
